<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🦋 Image Classification - Butterfly Classification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary-color: #6a4c93;
            --secondary-color: #f8f9fa;
            --accent-color: #ff6b6b;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        
        .navbar-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 15px 0;
        }
        
        .navbar-brand {
            color: white !important;
            font-weight: 800;
            font-size: 1.8rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .navbar-brand:hover {
            transform: scale(1.05);
            text-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        
        .nav-link {
            color: rgba(255,255,255,0.9) !important;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 12px 20px !important;
            margin: 0 5px;
            border-radius: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .nav-link:hover::before {
            left: 100%;
        }
        
        .nav-link:hover {
            color: white !important;
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .nav-link.active {
            background: rgba(255,255,255,0.2);
            color: white !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .navbar-toggler {
            border: none;
            padding: 8px 12px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        
        .navbar-toggler:focus {
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }
        
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.9%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        
        /* Enhanced body background with animated gradient */
        body {
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Enhanced upload container */
        .upload-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .upload-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transform: scaleX(0);
            transition: transform 0.6s ease;
        }
        
        .upload-container:hover::before {
            transform: scaleX(1);
        }
        
        .upload-container:hover {
            transform: translateY(-10px);
            box-shadow: 0 30px 60px rgba(0,0,0,0.15);
        }
        
        /* Enhanced file input */
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .file-input-wrapper:hover {
            transform: scale(1.05);
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 20px 40px;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            color: white;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .file-input-label::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .file-input-label:hover::before {
            left: 100%;
        }
        
        .file-input-label:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        
        /* Enhanced buttons */
        .btn-custom {
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-custom::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .btn-custom:hover::before {
            left: 100%;
        }
        
        .btn-custom:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        
        /* Enhanced results display */
        .results-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            margin-top: 30px;
            animation: slideInUp 0.6s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Enhanced map container */
        .map-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        /* Loading animation */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(106, 76, 147, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Enhanced species info */
        .species-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
        }
        
        .species-info:hover {
            transform: translateX(10px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        /* Enhanced confidence display */
        .confidence-display {
            background: linear-gradient(45deg, var(--success-color), #20c997);
            color: white;
            border-radius: 20px;
            padding: 15px 25px;
            text-align: center;
            font-weight: 600;
            font-size: 1.2rem;
            margin: 20px 0;
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .classify-header {
            background: linear-gradient(135deg, #6a4c93 0%, #8e44ad 100%);
            color: white;
            padding: 40px 0;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .upload-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .upload-area {
            border: 3px dashed #6a4c93;
            border-radius: 15px;
            padding: 40px;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8f9fa;
        }
        
        .upload-area:hover {
            border-color: #8e44ad;
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #6a4c93;
            margin-bottom: 20px;
        }
        
        .btn-custom {
            background: linear-gradient(135deg, #6a4c93 0%, #8e44ad 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(106, 76, 147, 0.3);
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(106, 76, 147, 0.4);
            color: white;
        }
        
        .result-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: none;
        }
        
        .species-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #6a4c93;
        }
        
        .map-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        #googleMap {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            background-color: #f8f9fa;
        }
        
        /* Ensure map container is properly sized */
        .map-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        
        /* Map loading indicator */
        .map-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }
        
        .map-loading .spinner-border {
            margin-right: 10px;
        }
        
        .location-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .location-list {
            list-style: none;
            padding: 0;
        }
        
        .location-list li {
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .location-list li:last-child {
            border-bottom: none;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .legend-color.primary {
            background: #28a745;
        }
        
        .legend-color.secondary {
            background: #ffc107;
        }
        
        .legend-color.migration {
            background: #17a2b8;
        }
        
        .file-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner-border {
            color: #6a4c93;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-butterfly me-2"></i>Butterfly Classification
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard"><i class="fas fa-chart-bar me-1"></i>Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/classify"><i class="fas fa-camera me-1"></i>Classify</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/database"><i class="fas fa-database me-1"></i>Database</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="classify-header">
        <div class="container">
            <h1><i class="fas fa-camera me-3"></i>Image Classification</h1>
            <p class="lead mb-0">Upload a butterfly or moth image to identify the species and learn more about it</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Upload Section -->
        <div class="upload-container">
            <h3 class="mb-4"><i class="fas fa-upload me-2"></i>Upload Your Image</h3>
            
            <div id="uploadArea" class="upload-area">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h4>Drag & Drop your image here</h4>
                <p class="text-muted">or click to browse files</p>
                <p class="text-muted small">Supported formats: JPG, PNG, GIF (Max 10MB)</p>
            </div>
            
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            
            <button id="classifyBtn" class="btn btn-custom btn-lg" onclick="classifyImage()" disabled>
                <i class="fas fa-search me-2"></i>Classify Image
            </button>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Analyzing your image...</p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message"></div>

        <!-- Results Section -->
        <div id="resultContainer" class="result-container">
            <h3 class="mb-4"><i class="fas fa-search me-2"></i>Classification Results</h3>
            
            <!-- Image Preview -->
            <div class="text-center mb-4">
                <img id="imagePreview" class="file-preview" alt="Uploaded image">
            </div>
            
            <!-- Species Information -->
            <div id="speciesInfo" class="species-card">
                <h4 id="speciesName" class="text-primary">-</h4>
                <p id="scientificName" class="text-muted">-</p>
                <p id="descriptionText" class="text-muted">-</p>
            </div>
            
            <!-- Google Maps Section -->
            <div class="map-container">
                <h5><i class="fas fa-globe me-2 text-primary"></i>Geographic Distribution</h5>
                <div id="mapLoading" class="map-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading map...</span>
                    </div>
                    <span class="text-muted">Loading world map...</span>
                </div>
                <div id="googleMap" style="display: none;"></div>
                <div class="map-legend mt-3">
                    <div class="legend-item">
                        <span class="legend-color primary"></span>
                        <span>Primary Habitat</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color secondary"></span>
                        <span>Secondary Range</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color migration"></span>
                        <span>Migration Route</span>
                    </div>
                </div>
            </div>
            
            <!-- Location Information -->
            <div class="location-info">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-map-marker-alt text-primary me-2"></i>Primary Locations</h6>
                        <ul id="primaryLocations" class="location-list">
                            <li>Loading locations...</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-route text-info me-2"></i>Migration Patterns</h6>
                        <p id="migrationInfo" class="text-muted">Information will appear after classification</p>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="text-center mt-4">
                <button class="btn btn-custom me-3" onclick="classifyNewImage()">
                    <i class="fas fa-plus me-2"></i>Classify Another Image
                </button>
                <button class="btn btn-outline-primary" onclick="downloadReport()">
                    <i class="fas fa-download me-2"></i>Download Report
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentFile = null;
        let classificationResult = null;
        let map = null;
        let markers = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initializeMap();
        });

        // Setup event listeners
        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // Click to upload
            uploadArea.addEventListener('click', () => fileInput.click());

            // File input change
            fileInput.addEventListener('change', handleFileSelect);

            // Drag and drop
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
        }

        // Prevent default drag behaviors
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Handle drag over
        function handleDragOver(e) {
            preventDefaults(e);
            document.getElementById('uploadArea').classList.add('dragover');
        }

        // Handle drag leave
        function handleDragLeave(e) {
            preventDefaults(e);
            document.getElementById('uploadArea').classList.remove('dragover');
        }

        // Handle drop
        function handleDrop(e) {
            preventDefaults(e);
            document.getElementById('uploadArea').classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        // Handle file selection
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // Handle file
        function handleFile(file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showError('Please select an image file.');
                return;
            }

            // Validate file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                showError('File size must be less than 10MB.');
                return;
            }

            currentFile = file;
            
            // Display preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
            };
            reader.readAsDataURL(file);

            // Enable classify button
            document.getElementById('classifyBtn').disabled = false;
            
            // Hide any previous results
            document.getElementById('resultContainer').style.display = 'none';
            hideError();
        }

        // Classify image
        async function classifyImage() {
            if (!currentFile) {
                showError('Please select an image first.');
                return;
            }

            // Show loading
            showLoading(true);
            hideError();

            try {
                const formData = new FormData();
                formData.append('image', currentFile);

                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                classificationResult = result;
                displayResults(result);
                
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to classify image. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Display results
        function displayResults(result) {
            // Extract species data
            let speciesData = result;
            if (result.species && typeof result.species === 'object') {
                speciesData = result.species;
            }

            // Update species information
            document.getElementById('speciesName').textContent = speciesData.common_name || 'Unknown Species';
            document.getElementById('scientificName').textContent = speciesData.scientific_name || 'Unknown';
            document.getElementById('descriptionText').textContent = speciesData.description || 'No description available.';

            // Populate map with species data
            populateMapWithSpeciesData(speciesData);

            // Show results
            document.getElementById('resultContainer').style.display = 'block';
            
            // Scroll to results
            document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // Initialize Simple SVG Map
        function initializeMap() {
            console.log('🗺️ Initializing simple SVG map...');
            const mapElement = document.getElementById('googleMap');
            const mapLoading = document.getElementById('mapLoading');
            
            if (!mapElement) {
                console.error('❌ Map element not found');
                return;
            }
            
            if (!mapLoading) {
                console.error('❌ Map loading element not found');
                return;
            }

            try {
                // Hide loading indicator
                mapLoading.style.display = 'none';
                
                // Create simple SVG world map
                const svgMap = createSimpleWorldMap();
                mapElement.innerHTML = '';
                mapElement.appendChild(svgMap);
                mapElement.style.display = 'block';
                
                console.log('✅ Simple SVG map created successfully');
                
            } catch (error) {
                console.error('❌ Error creating map:', error);
                // Show error message
                mapLoading.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                        <p class="mt-2 text-muted">Map unavailable. Please refresh the page.</p>
                    </div>
                `;
            }
        }

        // Create simple SVG world map
        function createSimpleWorldMap() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '400');
            svg.setAttribute('viewBox', '0 0 800 400');
            svg.style.borderRadius = '10px';
            svg.style.border = '2px solid #e9ecef';
            svg.style.backgroundColor = '#e6f3ff';
            
            // Add title
            const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            title.setAttribute('x', '400');
            title.setAttribute('y', '30');
            title.setAttribute('text-anchor', 'middle');
            title.setAttribute('font-size', '18');
            title.setAttribute('font-weight', 'bold');
            title.setAttribute('fill', '#6a4c93');
            title.textContent = 'World Map - Geographic Distribution';
            svg.appendChild(title);
            
            // Draw continents
            const continents = [
                // North America
                { path: 'M 80,80 L 200,80 L 200,200 L 80,200 Z', name: 'North America', x: 140, y: 140 },
                // South America
                { path: 'M 120,250 L 200,250 L 200,380 L 120,380 Z', name: 'South America', x: 160, y: 315 },
                // Europe
                { path: 'M 320,60 L 400,60 L 400,140 L 320,140 Z', name: 'Europe', x: 360, y: 100 },
                // Africa
                { path: 'M 320,160 L 400,160 L 400,320 L 320,320 Z', name: 'Africa', x: 360, y: 240 },
                // Asia
                { path: 'M 480,60 L 720,60 L 720,200 L 480,200 Z', name: 'Asia', x: 600, y: 130 },
                // Australia
                { path: 'M 520,280 L 640,280 L 640,340 L 520,340 Z', name: 'Australia', x: 580, y: 310 }
            ];
            
            continents.forEach(continent => {
                // Create continent shape
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', continent.path);
                path.setAttribute('fill', '#d4e6f1');
                path.setAttribute('stroke', '#6a4c93');
                path.setAttribute('stroke-width', '2');
                path.style.cursor = 'pointer';
                
                // Add hover effect
                path.addEventListener('mouseenter', function() {
                    this.setAttribute('fill', '#b8d4e6');
                });
                path.addEventListener('mouseleave', function() {
                    this.setAttribute('fill', '#d4e6f1');
                });
                
                svg.appendChild(path);
                
                // Add continent label
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', continent.x);
                label.setAttribute('y', continent.y);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('font-size', '12');
                label.setAttribute('font-weight', 'bold');
                label.setAttribute('fill', '#6a4c93');
                label.textContent = continent.name;
                svg.appendChild(label);
            });
            
            // Add ocean labels
            const oceans = [
                { x: 140, y: 50, name: 'Atlantic Ocean' },
                { x: 600, y: 50, name: 'Pacific Ocean' },
                { x: 600, y: 250, name: 'Indian Ocean' }
            ];
            
            oceans.forEach(ocean => {
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', ocean.x);
                label.setAttribute('y', ocean.y);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('font-size', '10');
                label.setAttribute('fill', '#6a4c93');
                label.style.fontStyle = 'italic';
                label.textContent = ocean.name;
                svg.appendChild(label);
            });
            
            return svg;
        }

        // Add location markers to the SVG map
        function addLocationMarkers(locations) {
            const mapElement = document.getElementById('googleMap');
            if (!mapElement || !mapElement.querySelector('svg')) return;
            
            const svg = mapElement.querySelector('svg');
            
            // Clear existing markers
            const existingMarkers = svg.querySelectorAll('.location-marker');
            existingMarkers.forEach(marker => marker.remove());
            
            if (!locations || locations.length === 0) return;
            
            locations.forEach(location => {
                // Convert lat/lng to SVG coordinates (simplified)
                const x = (location.lng + 180) * (800 / 360);
                const y = (90 - location.lat) * (400 / 180);
                
                // Create marker circle
                const marker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                marker.setAttribute('cx', x);
                marker.setAttribute('cy', y);
                marker.setAttribute('r', '8');
                marker.setAttribute('fill', getMarkerColor(location.type));
                marker.setAttribute('stroke', 'white');
                marker.setAttribute('stroke-width', '2');
                marker.classList.add('location-marker');
                marker.style.cursor = 'pointer';
                
                // Add tooltip
                const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
                title.textContent = `${location.name}: ${location.info || ''}`;
                marker.appendChild(title);
                
                svg.appendChild(marker);
                
                // Add location label
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', x);
                label.setAttribute('y', y - 15);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('font-size', '10');
                label.setAttribute('fill', '#6a4c93');
                label.setAttribute('font-weight', 'bold');
                label.textContent = location.name;
                svg.appendChild(label);
            });
        }

        // Get marker color based on type
        function getMarkerColor(type) {
            switch (type) {
                case 'primary': return '#28a745';
                case 'secondary': return '#ffc107';
                case 'migration': return '#17a2b8';
                default: return '#6a4c93';
            }
        }

        // Update location lists
        function updateLocationLists(speciesData) {
            const primaryList = document.getElementById('primaryLocations');
            const migrationInfo = document.getElementById('migrationInfo');

            if (speciesData.distribution) {
                const primaryLocations = speciesData.distribution.filter(loc => loc.type === 'primary');
                const migrationLocations = speciesData.distribution.filter(loc => loc.type === 'migration');

                // Update primary locations
                primaryList.innerHTML = primaryLocations.length > 0 
                    ? primaryLocations.map(loc => `<li>${loc.name}</li>`).join('')
                    : '<li>No primary locations found</li>';

                // Update migration info
                if (migrationLocations.length > 0) {
                    migrationInfo.textContent = `Found ${migrationLocations.length} migration routes`;
                } else {
                    migrationInfo.textContent = 'No migration patterns detected';
                }
            } else {
                primaryList.innerHTML = '<li>No location data available</li>';
                migrationInfo.textContent = 'No migration data available';
            }
        }

        // Populate map with species data
        function populateMapWithSpeciesData(speciesData) {
            console.log('🗺️ Populating map with species data:', speciesData);
            
            // Add location markers to the SVG map
            if (speciesData.distribution && speciesData.distribution.length > 0) {
                addLocationMarkers(speciesData.distribution);
                console.log('✅ Added location markers to map');
            } else {
                console.log('⚠️ No distribution data available');
                // Add a default marker if no distribution data
                addLocationMarkers([{
                    lat: 20, 
                    lng: 0, 
                    name: 'Unknown Location', 
                    type: 'primary', 
                    info: 'Location data not available'
                }]);
            }

            // Update location lists
            updateLocationLists(speciesData);
        }

        // Classify new image
        function classifyNewImage() {
            // Reset form
            document.getElementById('fileInput').value = '';
            document.getElementById('imagePreview').src = '';
            document.getElementById('classifyBtn').disabled = true;
            document.getElementById('resultContainer').style.display = 'none';
            
            // Clear map markers
            const mapElement = document.getElementById('googleMap');
            if (mapElement && mapElement.querySelector('svg')) {
                const existingMarkers = mapElement.querySelectorAll('.location-marker');
                existingMarkers.forEach(marker => marker.remove());
            }
            
            // Hide error
            hideError();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Reset current file
            currentFile = null;
            classificationResult = null;
        }

        // Download report
        function downloadReport() {
            if (!classificationResult) {
                showError('No classification result to download.');
                return;
            }

            // Create report content
            let speciesData = classificationResult;
            if (classificationResult.species && typeof classificationResult.species === 'object') {
                speciesData = classificationResult.species;
            }

            const report = `
Butterfly Classification Report
=============================

Species: ${speciesData.common_name || 'Unknown'}
Scientific Name: ${speciesData.scientific_name || 'Unknown'}
Description: ${speciesData.description || 'No description available'}

Classification Date: ${new Date().toLocaleString()}
Confidence: ${classificationResult.confidence || 'Unknown'}%

Generated by Butterfly Classification Ecosystem
            `;

            // Create and download file
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `butterfly_classification_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Show loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Show error
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // Hide error
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>
